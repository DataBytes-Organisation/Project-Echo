<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Echo Admin - Node Network</title>
  <link rel="shortcut icon" type="image/png" href="./admin/images/logos/favicon.png" />
  <link type="text/css" rel="stylesheet" href="./admin/css/styles.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <script type="text/javascript" src="https://kit.fontawesome.com/8aa980d912.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/dist/dist/vis-network.min.css" />
  <style>
    #network-container {
      width: 100%;
      height: 700px;
      border: 1px solid #ddd;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
      position: relative;
    }
    .node-details {
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .card-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #2a3547;
      margin-bottom: 1.5rem;
      padding-top: 20px;
    }
    .component-card {
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 8px;
      background: #f8f9fa;
    }
    .component-card h5 {
      margin: 0;
      color: #2a3547;
      font-size: 1.1rem;
    }
    .component-card .properties {
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .property-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      padding: 5px 0;
      border-bottom: 1px dashed #eee;
    }
    body {
      background-color: #f4f6f9;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .card {
      padding: 20px;
      margin-top: 20px;
    }
    .legend-container {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      font-size: 0.9rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .legend-icon {
      margin-right: 8px;
      font-size: 1.2rem;
    }
    .controls-container {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
    }
    .export-btn {
      height: 38px;
      width: 150px;
      padding: 0 12px;
      font-size: 1rem;
      line-height: 1.5;
    }
    .zoom-btn {
      height: 38px;
      width: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    .reset-btn {
      height: 38px;
      width: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .reset-btn:hover {
      background-color: #f0f0f0;
    }
    .custom-dropdown {
      position: relative;
      width: 150px;
      appearance: none;
      padding: 6px 30px 6px 10px;
    }
    .custom-dropdown::after {
      content: 'âˆ¨';
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      pointer-events: none;
      font-size: 1rem;
    }
    .text-muted {
      color: #6c757d !important;
    }
    .accordion-button {
      font-weight: 500;
      color: #2a3547;
    }
    .accordion-body {
      font-size: 0.9rem;
      color: #6c757d;
    }
  </style>
</head>

<body>
  <andia id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full" data-sidebar-position="fixed" data-header-position="fixed">
    <div id="sidebar"></div>
    <div class="body-wrapper">
      <div id="header"></div>
      <div class="container-fluid py-4">
        <div class="row">
          <div class="col-12">
            <div class="card p-4">
              <h5 class="card-title fw-semibold mb-4">Node Network</h5>
              <div class="controls-container">
                <button id="exportNetwork" class="btn btn-primary export-btn">Export Map</button>
                <button id="zoomIn" class="btn btn-outline-secondary zoom-btn" title="Zoom In"><i class="fas fa-plus"></i></button>
                <button id="zoomOut" class="btn btn-outline-secondary zoom-btn" title="Zoom Out"><i class="fas fa-minus"></i></button>
                <button id="resetMap" class="reset-btn" title="Reset Map"><i class="fas fa-crosshairs"></i></button>
              </div>
              <div id="network-container">
                <div class="legend-container">
                  <div class="legend-item">
                    <i class="fas fa-cogs legend-icon"></i> Master
                  </div>
                  <div class="legend-item">
                    <i class="fas fa-raspberry-pi legend-icon"></i> Raspberry Pi
                  </div>
                  <div class="legend-item">
                    <i class="fas fa-cog legend-icon"></i> Arduino
                  </div>
                  <div class="legend-item">
                    <i class="fas fa-microchip legend-icon"></i> Beta Sub
                  </div>
                </div>
              </div>
              <div id="node-details" class="node-details" style="display: none;">
                <h4 id="node-title" class="mb-4"></h4>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <strong>Type:</strong> <span id="node-type"></span>
                    </div>
                    <div class="mb-3">
                      <strong>Model:</strong> <span id="node-model"></span>
                    </div>
                    <div class="mb-3">
                      <strong>Location:</strong> <span id="node-location"></span>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <strong>Custom Properties</strong>
                      <div id="node-properties"></div>
                    </div>
                  </div>
                </div>
                <h5 class="mt-4 mb-3">Components</h5>
                <div id="node-components"></div>
              </div>
              <div class="node-descriptions mt-4">
                <h5 class="mb-3">Node Descriptions</h5>
                <div class="accordion" id="nodeDescriptionAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingMaster">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMaster" aria-expanded="false" aria-controls="collapseMaster">
                        Master
                      </button>
                    </h2>
                    <div id="collapseMaster" class="accordion-collapse collapse" aria-labelledby="headingMaster" data-bs-parent="#nodeDescriptionAccordion">
                      <div class="accordion-body">
                        The Master Node serves as the central controller in the network, coordinating communication and data processing across all connected nodes. It is designed for high reliability and can manage multiple sub-nodes efficiently.
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingRaspberryPi">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRaspberryPi" aria-expanded="false" aria-controls="collapseRaspberryPi">
                        Raspberry Pi
                      </button>
                    </h2>
                    <div id="collapseRaspberryPi" class="accordion-collapse collapse" aria-labelledby="headingRaspberryPi" data-bs-parent="#nodeDescriptionAccordion">
                      <div class="accordion-body">
                        The Raspberry Pi node is a versatile, single-board computer used for tasks like data logging, sensor integration, and local processing. It supports a wide range of projects due to its GPIO capabilities.
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingArduino">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseArduino" aria-expanded="false" aria-controls="collapseArduino">
                        Arduino
                      </button>
                    </h2>
                    <div id="collapseArduino" class="accordion-collapse collapse" aria-labelledby="headingArduino" data-bs-parent="#nodeDescriptionAccordion">
                      <div class="accordion-body">
                        The Arduino node is a microcontroller platform ideal for real-time control and sensor interfacing. It is lightweight and efficient, perfect for simple automation tasks.
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingBetaSub">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBetaSub" aria-expanded="false" aria-controls="collapseBetaSub">
                        Beta Sub
                      </button>
                    </h2>
                    <div id="collapseBetaSub" class="accordion-collapse collapse" aria-labelledby="headingBetaSub" data-bs-parent="#nodeDescriptionAccordion">
                      <div class="accordion-body">
                        The Beta Sub node is a prototype or secondary node type, often used for testing new features or as a backup. It supports limited functionality but is scalable for future upgrades.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="status-descriptions mt-4">
                <h5 class="mb-3">Node Status Descriptions</h5>
                <div class="accordion" id="statusDescriptionAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOnline">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOnline" aria-expanded="false" aria-controls="collapseOnline">
                        Online
                      </button>
                    </h2>
                    <div id="collapseOnline" class="accordion-collapse collapse" aria-labelledby="headingOnline" data-bs-parent="#statusDescriptionAccordion">
                      <div class="accordion-body">
                        The node is fully operational, actively connected to the network, and communicating with other nodes without issues.
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOffline">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOffline" aria-expanded="false" aria-controls="collapseOffline">
                        Offline
                      </button>
                    </h2>
                    <div id="collapseOffline" class="accordion-collapse collapse" aria-labelledby="headingOffline" data-bs-parent="#statusDescriptionAccordion">
                      <div class="accordion-body">
                        The node is not connected to the network and is not responding. It may be powered off, disconnected, or experiencing a failure.
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingWarning">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWarning" aria-expanded="false" aria-controls="collapseWarning">
                        Warning
                      </button>
                    </h2>
                    <div id="collapseWarning" class="accordion-collapse collapse" aria-labelledby="headingWarning" data-bs-parent="#statusDescriptionAccordion">
                      <div class="accordion-body">
                        The node is operational but experiencing issues, such as intermittent connectivity, high latency, or resource constraints.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="./admin/js/sidebarmenu.js"></script>
  <script type="text/javascript" src="./admin/js/app.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/dist/vis-network.min.js"></script>
  <script>
    $(document).ready(function() {
      $("#sidebar").load("./admin/component/sidebar-component.html");
      $("#header").load("./admin/component/header-component.html");
    });

    async function initNetwork() {
      try {
        const response = await fetch('http://localhost:9000/iot/nodes');
        const nodes = await response.json();

        const nodeData = nodes.map(node => ({
          id: node._id,
          label: node.name,
          title: `${node.name}\n${node.type}\n${node.model}`,
          shape: 'icon',
          icon: {
            face: 'FontAwesome',
            code: node.type === 'master' ? '\uf0e4' : node.type === 'raspberry_pi' ? '\uf7b9' : node.type === 'arduino' ? '\uf2db' : '\uf0e4',
            size: 40,
            color: node.type === 'master' ? '#2196F3' : node.type === 'raspberry_pi' ? '#C0392B' : node.type === 'arduino' ? '#4CAF50' : '#2196F3'
          }
        }));

        const edges = [];
        nodes.forEach(node => {
          if (node.connectedNodes) {
            node.connectedNodes.forEach(targetId => {
              edges.push({
                from: node._id,
                to: targetId,
                arrows: { to: true },
                color: { color: '#2B547E', highlight: '#1E90FF' },
                width: 2
              });
            });
          }
        });

        const container = document.getElementById('network-container');
        const data = {
          nodes: new vis.DataSet(nodeData),
          edges: new vis.DataSet(edges)
        };

        const options = {
          nodes: {
            size: 20,
            font: { size: 14 }
          },
          edges: {
            width: 2,
            color: { color: '#2B547E', highlight: '#1E90FF' }
          },
          physics: {
            stabilization: true,
            barnesHut: { gravitationalConstant: -10000, springConstant: 0.002 }
          }
        };

        network = new vis.Network(container, data, options);

        network.on('stabilizationIterationsDone', function() {
          const positions = network.getPositions();
          Object.keys(positions).forEach(id => {
            nodePositions[id] = positions[id];
          });
        });

        network.on('click', async function(params) {
          if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const response = await fetch(`http://localhost:9000/iot/nodes/${nodeId}`);
            const node = await response.json();
            showNodeDetails(node);
          }
        });

        network.on('hoverNode', function(params) {
          const nodeId = params.node;
          const node = nodesDataSet.get(nodeId);
          nodesDataSet.update({
            id: nodeId,
            title: `${node.label}\n${node.type}\n${node.model}\nLoading stats...`
          });
        });

        // Export as Image
        document.getElementById('exportNetwork').addEventListener('click', function() {
          const canvas = network.canvas.frame.canvas;
          const dataUrl = canvas.toDataURL('image/png');
          const link = document.createElement('a');
          link.download = 'node_network.png';
          link.href = dataUrl;
          link.click();
        });

        // Zoom In and Zoom Out
        let currentScale = 1;
        const zoomStep = 0.2;

        document.getElementById('zoomIn').addEventListener('click', function() {
          currentScale += zoomStep;
          network.moveTo({ scale: currentScale });
        });

        document.getElementById('zoomOut').addEventListener('click', function() {
          currentScale = Math.max(0.2, currentScale - zoomStep);
          network.moveTo({ scale: currentScale });
        });

        document.getElementById('resetMap').addEventListener('click', function() {
          currentScale = 1; 
          network.fit(); 
        });

      } catch (error) {
        console.error('Error initializing network:', error);
      }
    }

    function showNodeDetails(node) {
      document.getElementById('node-details').style.display = 'block';
      document.getElementById('node-title').textContent = node.name;
      document.getElementById('node-type').textContent = node.type;
      document.getElementById('node-model').textContent = node.model;
      document.getElementById('node-location').textContent = `${node.location.latitude}, ${node.location.longitude}`;

      const propertiesDiv = document.getElementById('node-properties');
      propertiesDiv.innerHTML = '';
      Object.entries(node.customProperties).forEach(([key, value]) => {
        propertiesDiv.innerHTML += `<div class="property-item">
          <span>${key}:</span> <span>${value}</span>
        </div>`;
      });

      const componentsDiv = document.getElementById('node-components');
      componentsDiv.innerHTML = '';
      if (node.components && node.components.length > 0) {
        node.components.forEach(component => {
          componentsDiv.innerHTML += `
            <div class="component-card">
              <h5>${component.type} - ${component.model}</h5>
              <div class="properties">
                ${Object.entries(component.customProperties)
                  .map(([key, value]) => `
                    <div class="property-item">
                      <span>${key}:</span> <span>${value}</span>
                    </div>
                  `).join('')}
              </div>
            </div>
          `;
        });
      } else {
        componentsDiv.innerHTML = '<p>No components found.</p>';
      }
    }

    window.addEventListener('load', initNetwork);
  </script>