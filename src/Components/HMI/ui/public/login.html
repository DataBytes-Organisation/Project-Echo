<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Echo | Login</title>

  <!-- Styles and Fonts -->
  <link rel="stylesheet" href="/css/ol.css">
  <link rel="stylesheet" href="/css/splash_screen_style.css">
  <link rel="stylesheet" href="/css/HMI_style.css">
  <link rel="stylesheet" href="/css/auth-form.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  <!-- Scripts -->
  <script src="/js/ol.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script src="https://www.google.com/recaptcha/enterprise.js?render=6LdKhsUpAAAAAOyJT8u_gBte7HBoFKUvO0-bz_2v"></script>

  <style>
    .user-auth-form.modal {
      display: none;
    }

    #blur {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      backdrop-filter: blur(5px);
      z-index: 1;
    }
  </style>
</head>

<body>
  <div class="screen" id="screen">
    <div class="screen-image"></div>
    <div class="screen-overlay"></div>
    <div class="screen-content">
      <img src="./images/logo-splashscreen.png" style="width: 101px; height: 81px">
      <div class="screen-user">
        <ul>
          <li><span onclick="openForm('login-form-container')">Login</span></li>
          <li><span onclick="openForm('signup-form')">Register</span></li>
          <li><span onclick="openForm('request-access-form')">Guest Request</span></li>
        </ul>
        <span class="name animate" id="name" data-value="PROJECT ECHO">PROJECT ECHO</span>
      </div>
    </div>

    <!-- Login Modal -->
    <div id="login-form-container" class="user-auth-form modal">
      <form class="modal-content animate" id="login-form">
        <div class="imgcontainer">
          <span onclick="closeForm('login-form-container')" class="close">&times;</span>
        </div>
        <div class="container">
          <div id="usernameInput">
            <label for="username"><b>Username</b></label>
            <input id="username" name="username" type="text" placeholder="Username" required>
          </div>
          <div id="emailInput" style="display:none;">
            <label for="email"><b>Email</b></label>
            <input id="email" name="email" type="email" placeholder="Email">
          </div>
          <label for="password"><b>Password</b></label>
          <input id="password" name="password" type="password" placeholder="Password" required>

          <input type="checkbox" id="switchInput" onclick="toggleLoginType()">
          <label for="switchInput">Use Email instead</label>

          <div class="g-recaptcha" data-sitekey="6LdKhsUpAAAAAOyJT8u_gBte7HBoFKUvO0-bz_2v" data-callback="checkCaptcha"></div>
          <button id="login-form-container-submit" type="submit" class="btn10 animate disabled" disabled>Login</button>

          <label>
            <input type="checkbox" checked name="remember"> Remember me
          </label>
        </div>
        <div class="container" style="background-color:#f1f1f1">
          <button type="button" class="cancelbtn" onclick="closeForm('login-form-container')">Cancel</button>
          <span class="psw" onclick="closeForm('login-form-container'); openForm('forgotpassword-form')">
            <a href="#">Forgot password?</a>
          </span>
        </div>
      </form>
    </div>
  </div>

  <div id="blur"></div>

  <script>
    function openForm(id) {
      document.getElementById(id).style.display = 'block';
      document.getElementById('blur').style.display = 'block';
    }
    function closeForm(id) {
      document.getElementById(id).style.display = 'none';
      document.getElementById('blur').style.display = 'none';
    }
    function toggleLoginType() {
      const useEmail = document.getElementById('switchInput').checked;
      document.getElementById('usernameInput').style.display = useEmail ? 'none' : 'block';
      document.getElementById('emailInput').style.display = useEmail ? 'block' : 'none';
      document.getElementById('username').required = !useEmail;
      document.getElementById('email').required = useEmail;
    }
    function checkCaptcha(token) {
      const btn = document.getElementById('login-form-container-submit');
      btn.disabled = false;
      btn.classList.remove('disabled');
    }

    document.getElementById('login-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const usingEmail = document.getElementById('switchInput').checked;

      const payload = { password };
      if (usingEmail) {
        payload.email = email;
      } else {
        payload.username = username;
      }

      try {
        const res = await fetch('/api/auth/signin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
        const data = await res.json();

        // Store token and userId
        localStorage.setItem('token', data.token);
        localStorage.setItem('userId', data.userId);

        // Store user email for analytics tracking
        const emailToTrack = data.user?.email || data.email || payload.email || payload.username || '';
        localStorage.setItem('userEmail', emailToTrack);

        // Debug: log the email being tracked
        console.log("Tracking visit for:", emailToTrack);

        fetch('http://localhost:8080/api/track-visit', {
        method: 'POST',
        headers: {
         'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            username: data.user?.username || payload.username || '',
            email: data.user?.email || payload.email || ''
        })
});

        // Proceed to welcome page
        window.location.href = '/welcome';
      } else {
          alert('Login failed. Check credentials.');
        }
      } catch (err) {
        console.error('Login error:', err);
        alert('An error occurred during login.');
      }
    });
  </script>
</body>

</html>